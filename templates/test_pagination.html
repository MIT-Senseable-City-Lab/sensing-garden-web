<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Unified Pagination Test</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link href="/static/css/styles.css" rel="stylesheet">
</head>
<body>
    <div class="container-fluid mt-3">
        <h2>Unified Feed Pagination Test</h2>
        <p class="text-muted">Testing chronological ordering with Load More functionality</p>
        
        <!-- Device Selection -->
        <div class="mb-3">
            <label for="deviceSelect" class="form-label">Select Device:</label>
            <select id="deviceSelect" class="form-select" style="max-width: 300px;">
                <option value="">Select a device to test...</option>
            </select>
        </div>
        
        <!-- Batch Size Controls -->
        <div class="mb-3">
            <div class="row">
                <div class="col-md-4">
                    <label for="initialBatchSize" class="form-label">Initial Batch Size:</label>
                    <input type="number" id="initialBatchSize" class="form-control" value="100" min="20" max="100">
                </div>
                <div class="col-md-4">
                    <label for="displayPageSize" class="form-label">Display Page Size:</label>
                    <input type="number" id="displayPageSize" class="form-control" value="20" min="5" max="50">
                </div>
                <div class="col-md-4">
                    <label for="loadMoreBatchSize" class="form-label">Load More Batch Size:</label>
                    <input type="number" id="loadMoreBatchSize" class="form-control" value="50" min="20" max="100">
                </div>
            </div>
        </div>
        
        <!-- Test Controls -->
        <div class="mb-3">
            <button id="initializeFeed" class="btn btn-primary">Initialize Feed</button>
            <button id="refreshFeed" class="btn btn-secondary">Refresh</button>
            <button id="clearFeed" class="btn btn-outline-danger">Clear</button>
        </div>
        
        <!-- Statistics -->
        <div class="mb-3">
            <div class="row">
                <div class="col-md-3">
                    <div class="card">
                        <div class="card-body">
                            <h6 class="card-title">Total Loaded</h6>
                            <span id="totalLoadedCount" class="h4">0</span>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card">
                        <div class="card-body">
                            <h6 class="card-title">Currently Displayed</h6>
                            <span id="displayedCount" class="h4">0</span>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card">
                        <div class="card-body">
                            <h6 class="card-title">Local Page</h6>
                            <span id="localPageCount" class="h4">0</span>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card">
                        <div class="card-body">
                            <h6 class="card-title">Chronological Order</h6>
                            <span id="chronologicalStatus" class="h4 text-success">✓</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Feed Timeline -->
        <div id="loadingIndicator" class="text-center py-5" style="display: none;">
            <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">Loading...</span>
            </div>
            <div class="mt-2">Loading feed data...</div>
        </div>
        
        <div id="errorMessage" class="alert alert-danger" style="display: none;">
            <strong>Error:</strong> <span id="errorText"></span>
        </div>
        
        <div id="emptyState" class="text-center py-5" style="display: none;">
            <i class="fas fa-inbox fa-3x text-muted mb-3"></i>
            <h5>No data available</h5>
            <p class="text-muted">Select a device and initialize the feed to see content.</p>
        </div>
        
        <div id="feedTimeline" class="timeline-container" style="display: none;">
            <!-- Timeline items will be inserted here -->
        </div>
        
        <!-- Load More Button -->
        <div id="loadMoreContainer" class="text-center py-4" style="display: none;">
            <button id="loadMoreBtn" class="btn btn-outline-primary btn-lg">
                <div id="loadMoreSpinner" class="spinner-border spinner-border-sm me-2" role="status" style="display: none;">
                    <span class="visually-hidden">Loading...</span>
                </div>
                <span id="loadMoreText">Load More</span>
            </button>
        </div>
    </div>

    <!-- Include JavaScript -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="/static/js/unified_feed.js"></script>
    
    <script>
        let testFeed = null;
        
        // Load devices on page load
        document.addEventListener('DOMContentLoaded', function() {
            loadDevices();
            setupEventListeners();
        });
        
        async function loadDevices() {
            try {
                const response = await fetch('/api/devices');
                const devices = await response.json();
                
                const select = document.getElementById('deviceSelect');
                select.innerHTML = '<option value="">Select a device to test...</option>';
                
                devices.forEach(device => {
                    const option = document.createElement('option');
                    option.value = device;
                    option.textContent = device;
                    select.appendChild(option);
                });
            } catch (error) {
                console.error('Failed to load devices:', error);
            }
        }
        
        function setupEventListeners() {
            document.getElementById('initializeFeed').addEventListener('click', initializeFeed);
            document.getElementById('refreshFeed').addEventListener('click', refreshFeed);
            document.getElementById('clearFeed').addEventListener('click', clearFeed);
            
            // Update statistics periodically
            setInterval(updateStatistics, 1000);
        }
        
        async function initializeFeed() {
            const deviceId = document.getElementById('deviceSelect').value;
            if (!deviceId) {
                alert('Please select a device first');
                return;
            }
            
            const initialBatchSize = parseInt(document.getElementById('initialBatchSize').value);
            const displayPageSize = parseInt(document.getElementById('displayPageSize').value);
            const loadMoreBatchSize = parseInt(document.getElementById('loadMoreBatchSize').value);
            
            // Clean up existing feed
            if (testFeed) {
                testFeed.cleanup();
            }
            
            // Create new feed instance with test configuration
            testFeed = new UnifiedFeed(deviceId, {
                apiBaseUrl: '',
                initialBatchSize: initialBatchSize,
                pageSize: displayPageSize,
                loadMoreBatchSize: loadMoreBatchSize
            });
            
            // Store globally for debugging
            window.testUnifiedFeedInstance = testFeed;
            
            // Set up Load More button click handler
            document.getElementById('loadMoreBtn').addEventListener('click', function() {
                if (testFeed) {
                    testFeed.loadMore();
                }
            });
            
            await testFeed.initialize();
            updateStatistics();
        }
        
        async function refreshFeed() {
            if (testFeed) {
                await testFeed.refresh();
                updateStatistics();
            }
        }
        
        function clearFeed() {
            if (testFeed) {
                testFeed.cleanup();
                testFeed = null;
            }
            
            document.getElementById('feedTimeline').innerHTML = '';
            document.getElementById('feedTimeline').style.display = 'none';
            document.getElementById('loadMoreContainer').style.display = 'none';
            document.getElementById('emptyState').style.display = 'block';
            updateStatistics();
        }
        
        function updateStatistics() {
            if (!testFeed) {
                document.getElementById('totalLoadedCount').textContent = '0';
                document.getElementById('displayedCount').textContent = '0';
                document.getElementById('localPageCount').textContent = '0';
                document.getElementById('chronologicalStatus').textContent = '—';
                document.getElementById('chronologicalStatus').className = 'h4 text-muted';
                return;
            }
            
            const totalLoaded = testFeed.allLoadedItems.length;
            const displayed = document.querySelectorAll('.timeline-item:not(.time-marker)').length;
            const localPage = testFeed.localPageIndex + 1;
            
            document.getElementById('totalLoadedCount').textContent = totalLoaded;
            document.getElementById('displayedCount').textContent = displayed;
            document.getElementById('localPageCount').textContent = localPage;
            
            // Check chronological order
            const chronologicalStatus = checkChronologicalOrder();
            const statusElement = document.getElementById('chronologicalStatus');
            
            if (chronologicalStatus.isCorrect) {
                statusElement.textContent = '✓';
                statusElement.className = 'h4 text-success';
                statusElement.title = 'Timeline is in correct chronological order';
            } else {
                statusElement.textContent = '✗';
                statusElement.className = 'h4 text-danger';
                statusElement.title = `Chronological order issue: ${chronologicalStatus.issues.join(', ')}`;
            }
        }
        
        function checkChronologicalOrder() {
            const timelineItems = document.querySelectorAll('.timeline-item:not(.time-marker)');
            const timestamps = [];
            const issues = [];
            
            timelineItems.forEach((item, index) => {
                const timestamp = item.getAttribute('data-timestamp');
                if (timestamp) {
                    const date = new Date(timestamp);
                    timestamps.push({ index, timestamp, date });
                }
            });
            
            // Check if timestamps are in descending order (newest first)
            for (let i = 1; i < timestamps.length; i++) {
                if (timestamps[i].date > timestamps[i-1].date) {
                    issues.push(`Item ${i} (${timestamps[i].timestamp}) is newer than item ${i-1} (${timestamps[i-1].timestamp})`);
                }
            }
            
            return {
                isCorrect: issues.length === 0,
                issues: issues,
                totalItems: timestamps.length
            };
        }
        
        // Debug functions
        window.getTestFeedStats = function() {
            if (testFeed) {
                return testFeed.getPerformanceStats();
            }
            return null;
        };
        
        window.checkChronology = checkChronologicalOrder;
    </script>
</body>
</html>