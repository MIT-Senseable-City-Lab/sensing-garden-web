{% extends "base.html" %}
{% from "table.html" import render_table, table_scripts %}

{% block title %}Videos for Device {{ device_id }}{% endblock %}

{% block content %}
<div class="container">
    <h2>Videos for Device {{ device_id }}</h2>
    <div class="mb-3">
        <a href="{{ url_for('view_device', device_id=device_id) }}" class="btn btn-secondary">Back to Device Overview</a>
    </div>

    {% if items %}
    <div class="mb-4">
        <h3>Videos</h3>
        <div class="table-responsive w-100">
            <table id="videos_table" class="table table-striped w-100" style="width: 100% !important;">
                <thead>
                    <tr>
                        <th>Timestamp</th>
                        <th>Video</th>
                        <th>Details</th>
                    </tr>
                </thead>
                <tbody>
                    {% for item in items %}
                    <tr>
                        <td>{{ item.get('formatted_time', item.get('timestamp', '')) }}</td>
                        <td>
                            {% if item.get('video_url') %}
                            <div class="video-container">
                                <video controls style="max-width: 100%; max-height: 200px;">
                                    <source src="{{ item.video_url }}" type="video/mp4">
                                    Your browser does not support the video tag.
                                </video>
                            </div>
                            {% else %}
                            <span class="text-muted">No video available</span>
                            {% endif %}
                        </td>
                        <td>
                            <button class="btn btn-sm btn-info" type="button" data-bs-toggle="collapse" 
                                    data-bs-target="#details-{{ loop.index }}" aria-expanded="false" 
                                    aria-controls="details-{{ loop.index }}">
                                Show Details
                            </button>
                            <div class="collapse mt-2" id="details-{{ loop.index }}">
                                <div class="card card-body">
                                    <dl class="row">
                                        {% for key, value in item.items() %}
                                        {% if key not in ['video_url', 'formatted_time'] %}
                                        <dt class="col-sm-4">{{ key }}</dt>
                                        <dd class="col-sm-8">{{ value }}</dd>
                                        {% endif %}
                                        {% endfor %}
                                    </dl>
                                </div>
                            </div>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>

        <!-- Pagination -->
        <div class="mt-3 text-center">
            <div class="btn-group" role="group" aria-label="Pagination">
                {% if pagination and pagination.has_prev %}
                <a href="{{ pagination.prev_url }}" class="btn btn-primary">Previous</a>
                {% endif %}

                {% if pagination and pagination.has_next %}
                <a href="{{ pagination.next_url }}" class="btn btn-primary">Next</a>
                {% endif %}
            </div>
        </div>
    </div>
    {% else %}
    <div class="alert alert-info">
        No videos found for this device.
    </div>
    {% endif %}
</div>
{% endblock %}

{% block scripts %}
<style>
    .video-container {
        position: relative;
        width: 100%;
        max-width: 320px;
    }
    
    video {
        border-radius: 4px;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    }
    
    .table-responsive {
        width: 100% !important;
        margin: 0 !important;
        overflow-x: auto !important;
    }
</style>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Initialize any Bootstrap components
        var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'))
        var tooltipList = tooltipTriggerList.map(function (tooltipTriggerEl) {
            return new bootstrap.Tooltip(tooltipTriggerEl)
        });
        
        // Add DataTable initialization if needed
        if (typeof $.fn.DataTable !== 'undefined') {
            $('#videos_table').DataTable({
                paging: false,
                searching: false,
                ordering: false,
                info: false,
                responsive: true,
                autoWidth: true
            });
        }
    });
</script>
{% endblock %}
